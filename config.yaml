log:
  level: info
  file: ""

api:
  http: "0.0.0.0:9091"

include:
  - "./data.yaml"
  - "./dns.yaml"

plugins:
  # 转发组 - 国内
  - tag: forward_cn_group
    type: fallback
    args:
      primary: ali
      secondary: dnspod
      threshold: 50
      always_standby: true

  # 转发组 - 国外/代理
  - tag: forward_remote_group
    type: fallback
    args:
      primary: google
      secondary: cloudflare
      threshold: 100
      always_standby: true

  # 不在名单中的域名
  - tag: sequence_not_in_list
    type: sequence
    args:
      - exec: $ecs_cn
      - exec: $forward_remote_group

      # 后续 fakeip 只处理 A/AAAA，其他 qtype 直接返回 remote 的结果
      - matches: "!qtype 1 28"
        exec: return

      # 不带 ECS 查就近
      - exec: $no_ecs

      # A/AAAA 是 CN IP → 国内再查一遍（获取更合适的国内 IP）
      - matches:
        - "qtype 1 28"
        - "resp_ip $geoip_cn"
        exec: $forward_cn_group

      # A/AAAA 无 IP → 国内再查一遍
      - matches:
        - "qtype 1 28"
        - "!resp_ip 0.0.0.0/0 ::/0"
        exec: $forward_cn_group

      # 国内查完如果无结果，返回（保留 NXDOMAIN/NODATA）
      - matches:
        - "qtype 1 28"
        - "!resp_ip 0.0.0.0/0 ::/0"
        exec: return

      # 国内查完：若是 CN IP，接受返回真实 IP
      - matches: "resp_ip $geoip_cn"
        exec: return

      # 剩下的情况（有 IP 且非 CN） → fakeip
      - exec: drop_resp
      - exec: $forward_fakeip
      - exec: return

  # 主逻辑
  - tag: sequence_main
    type: sequence
    args:
      # 1. geosite_local 交给 local 去解析
      - matches: qname $geosite_local
        exec: $local
      - matches: qname $geosite_local
        exec: accept

      # 2. geosite_custom 直接读取里面的解析地址
      - exec: $geosite_custom
      - matches: has_resp
        exec: accept

      # 3. geosite_block 直接返回无法解析
      - matches: qname $geosite_block
        exec: reject 3
      - matches: qname $geosite_block
        exec: return

      # 4. geosite_cn 走 ali 和 dnspod 去解析
      - matches: qname $geosite_cn
        exec: $forward_cn_group
      - matches: has_resp
        exec: accept

      # 5. geosite_proxy 走 fakeip 去解析
      - matches: qname $geosite_proxy
        exec: $forward_fakeip
      - matches: has_resp
        exec: accept

      # 6. 剩下的不在名单中的域名 兜底逻辑
      - exec: $sequence_not_in_list
      - matches: has_resp
        exec: accept

  # 启动服务器
  - tag: udp_main
    type: udp_server
    args:
      entry: sequence_main
      listen: ":53"

  - tag: tcp_main
    type: tcp_server
    args:
      entry: sequence_main
      listen: ":53"